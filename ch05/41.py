import os
from dotenv import load_dotenv
from google import genai
from google.genai.errors import APIError

# 1. 環境変数をロードする
# .env ファイルから GEMINI_API_KEY を読み込む
load_dotenv() 
api_key = os.getenv("GEMINI_API_KEY") 

# 2. Few-shot推論のためのプロンプトを構築

# --- 対象の問題 ---
problem = """
9世紀に活躍した人物に関係するできごとについて述べた次のア～ウを年代の古い順に正しく並べよ。
ア　藤原時平は，策謀を用いて菅原道真を政界から追放した。
イ　嵯峨天皇は，藤原冬嗣らを蔵人頭に任命した。
ウ　藤原良房は，承和の変後，藤原氏の中での北家の優位を確立した。
"""

# --- プロンプト（Few-shot推論） ---
prompt = f"""
以下の形式（問題と解答）に従って、最後の問題に解答してください。解答は、できごとの記号（ア、イ、ウ）のみを年代の古い順に「記号→記号→記号」の形式で出力してください。

--- 例題 ---
問題:
江戸幕府の北方での対外的な緊張について述べた次の文ア～ウを年代の古い順に正しく並べよ。
ア　レザノフが長崎に来航したが，幕府が冷淡な対応をしたため，ロシア船が樺太や択捉島を攻撃した。
イ　ゴローウニンが国後島に上陸し，幕府の役人に捕らえられ抑留された。
ウ　ラクスマンが根室に来航し，漂流民を届けるとともに通商を求めた。
解答: ウ→ア→イ

--- 例題 ---
問題:
中居屋重兵衛の生涯の期間におこったできごとについて述べた次のア～ウを，年代の古い順に正しく並べよ。
ア　アヘン戦争がおこり，清がイギリスに敗北した。
イ　異国船打払令が出され，外国船を撃退することが命じられた。
ウ　桜田門外の変がおこり，大老の井伊直弼が暗殺された。
解答: イ→ア→ウ

--- 例題 ---
問題:
加藤高明が外務大臣として提言を行ってから、内閣総理大臣となり演説を行うまでの時期のできごとについて述べた次のア～ウを，年代の古い順に正しく並べよ。
ア　朝鮮半島において，独立を求める大衆運動である三・一独立運動が展開された。
イ　関東大震災後の混乱のなかで，朝鮮人や中国人に対する殺傷事件がおきた。
ウ　日本政府が，袁世凱政府に対して二十一カ条の要求を突き付けた。
解答: ウ→ア→イ

--- 問題 ---
問題:
{problem.strip()}
解答:
"""

if api_key:
    try:
        # 3. クライアントの初期化
        client = genai.Client(api_key=api_key)

        print("--- Few-shot推論 プロンプトの確認 ---")
        print(prompt)
        print("\nGemini APIを呼び出し中...")

        # 4. モデルの呼び出し
        response = client.models.generate_content(
            model='gemini-2.5-flash', 
            contents=prompt,
        )

        # 5. 結果の表示
        print("\n--- Few-shot推論による解答 ---")
        answer = response.text.strip()
        print(answer)
        print("------------------------------")
        
    except APIError as e:
        print(f"API呼び出しエラーが発生しました: {e}")
    except Exception as e:
        print(f"予期せぬエラーが発生しました: {e}")
else:
    print("エラー: GEMINI_API_KEYが設定されていません。'.env'ファイルを確認してください。")
